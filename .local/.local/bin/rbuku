#!/bin/sh

# Set variables
BOOKMARK_HEADER="ðŸ”– rbuku"
BOOKMARK_FORMAT=40 # 10: URL, 20: URL TAGS, 30: TITLE, 40: URL TITLE TAGS, 50: TITLE TAGS

# Get all bookmarks
all_bookmarks=$(buku --nostdin --np -p --format="$BOOKMARK_FORMAT")

# Add bookmark function
add_bookmark() {
    url=$1
    tags=$(buku --np -t | rofi -dmenu -l 7 -i -p "$BOOKMARK_HEADER" -mesg "Select tags for $url (shift+enter to multi-select)" -multi-select | sed "s/[0-9]*\.//; s/([0-9]*)//; s/^[[:space:]]*//; s/[[:space:]]*$//;" | tr '\n' ',')
    if [ -z "$tags" ]; then
        exit 0
    fi
    notify-send "$BOOKMARK_HEADER" "Selected tags: $tags"
    title=$(rofi -dmenu -i -l 0 -p "$BOOKMARK_HEADER" -mesg "Add custom title for $url (empty for default)")
    if [ -z "$title" ]; then
        buku --np --tacit --add "$url" --tag "$tags"
    else
        buku --np --tacit --add "$url" --tag "$tags" --title "$title" --immutable 1
    fi
    notify-send "$BOOKMARK_HEADER" "Added $url bookmark: $tags"
}

# Select bookmark function
select_bookmark() {
    selection=$(echo "$all_bookmarks" | cut -f2- | rofi -dmenu -l 7 -i -p "$BOOKMARK_HEADER" -mesg 'Select bookmarks')
    if [ -n "$selection" ]; then
        echo "$all_bookmarks" | grep "$selection" | awk -F '\t' "{print \$1}"
    fi
}

# Open bookmark function
open_bookmark() {
    selection=$(echo "$all_bookmarks" | cut -f2- | rofi -dmenu -l 7 -i -p "$BOOKMARK_HEADER" -mesg 'Open bookmarks (shift+enter to multi-open)' -multi-select)
    if [ -n "$selection" ]; then
        url_list=$(echo "$all_bookmarks" | grep "$selection" | awk -F '\t' "{print \$1}")
        IFS=$'\n' # make newlines the only separator
        for url in $url_list; do
            linkhandler "$url"
        done
    fi
}

# Remove bookmark function
remove_bookmark() {
    ROW_FORMAT='d' # Integer row of selected items
    selection_index_list=$(echo "$all_bookmarks" | cut -f2- | rofi -dmenu -format "$ROW_FORMAT" -l 7 -i -p "$BOOKMARK_HEADER" -mesg 'Remove bookmarks (shift+enter to multi-select)' -no-custom -multi-select | tac)
    for i in $selection_index_list; do
        selection=$(buku --np -p --format=10 | head -n "$i" | tail -n 1)
        buku --np --tacit -d "$i"
        notify-send "$BOOKMARK_HEADER" "Removed $selection"
    done
}

# Main function
case "$1" in
    -a) add_bookmark "$2" ;;
    -r) remove_bookmark ;;
    -s) select_bookmark ;;
    *) open_bookmark ;;
esac
