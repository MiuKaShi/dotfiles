#!/bin/bash

file=$(readlink -f "$1")
filepath=$(dirname "$file")
filename=$(basename "$file")
filename_without_extension="${filename%.*}"
base="${file%.*}"
mdfile="${base}_txt.md"
tmpfile="${base}_en.md"
outputmd="${base}_zh.md"
mediapath="${filepath}/pdf_media"
mediafile="${mediapath}/${filename_without_extension}_med.pdf"

if [[ ! -f "$mdfile" ]]; then
    notify-send "No File" "Get markdown file first."
    exit 1
fi

translate_md() {
    notify-send "Translate MD" "English to Chinese..."
    cp -f "$mdfile" "$tmpfile"
    # remove unnecessary translation parts
    sed -i \
        -e '/^## *Reference/I,$ d' \
        -e '/^## *Acknowledg/I,$ d' \
        -e '/^## *Nomenclature/I,$ d' \
        -e '/^## *Declaration of competing/I,$ d' \
        -e '/^## *CRediT authorship/I,$ d' \
        -e '/^## *Data availability/I,$ d' \
        -e '/^## *Statement of original/I,$ d' \
        -e '/^## Funding/,$ d' \
        -e '/^## Declarations/,$ d' \
        "$tmpfile"
    cd "${HOME}"/.config/script/mdtranslate || exit
    python "${HOME}"/.config/script/mdtranslate/main.py "$tmpfile" "$outputmd"
    rm -f "$tmpfile"
}

action_view() {
    if [[ -f "$mediafile" ]]; then
        ACTION=$(printf "zh\nmedia" | dmenu -p "View:")
        case $ACTION in
            "zh")
                $TERMINAL -e "$EDITOR" "$outputmd"
                ;;
            "media")
                sioyek "$mediafile"
                ;;
        esac
        exit 0
    fi
}

if [[ ! -f "$outputmd" ]]; then
    translate_md
    notify-send "Translate MD" "finish!"
    [ -f /tmp/tokens ] && {
        tokens=$(sed -n '1p' /tmp/tokens)
        cost=$(sed -n '2p' /tmp/tokens | awk '{printf "%.3f", $0}')
        notify-send "Translate Fee" "All Tokens: $tokens, Cost: $cost CNY"
    }
else
    action_view
fi
$TERMINAL -e "$EDITOR" "$outputmd"
