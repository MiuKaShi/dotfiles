#!/bin/bash

file=$(readlink -f "$1")
base="${file%.*}"
mdfile="${base}_txt.md"
tmpfile="${base}_en.md"
outputmd="${base}_zh.md"
outputpdf="${base}_zh.pdf"

if [[ ! -f "$mdfile" ]]; then
    notify-send "No File" "Get markdown file first."
    exit 1
fi

translate_md() {
    notify-send "Translate MD" "English to Chinese..."
    cp -f "$mdfile" "$tmpfile"
    # remove unnecessary translation parts
    sed -i \
        -e '/^## *Reference/I,$ d' \
        -e '/^## *Acknowledg/I,$ d' \
        -e '/^## *Nomenclature/I,$ d' \
        -e '/^## *Declaration of competing/I,$ d' \
        -e '/^## *CRediT authorship/I,$ d' \
        -e '/^## *Data availability/I,$ d' \
        -e '/^## *Statement of original/I,$ d' \
        -e '/^## Funding/,$ d' \
        -e '/^## Declarations/,$ d' \
        "$tmpfile"
    cd "${HOME}"/.config/script/mdtranslate || exit
    python "${HOME}"/.config/script/mdtranslate/main.py "$tmpfile" "$outputmd"
    rm -f "$tmpfile"
}

if [[ ! -f "$outputmd" ]]; then
    translate_md
    notify-send "Translate MD" "finish!"
fi

ACTION=$(printf "MD\nPDF" | dmenu -p "View:")
case $ACTION in
    "MD")
        $TERMINAL -e "$EDITOR" "$outputmd"
        ;;
    "PDF")
        if [[ ! -f "$outputpdf" ]]; then
            compiler "$outputmd"
        fi
        $TERMINAL -e sioyek "$outputpdf"
        ;;
esac
