#! /bin/sh

dpi_env="$HOME/.config/shell/hidpi"

lab_dpi() {
    cat >"$dpi_env" <<EOF
#DPI setting for lab
export MONITOR_ENV=lab
#for QT5
export QT_AUTO_SCREEN_SCALE_FACTOR=1
# export QT_SCALE_FACTOR=2
#for QT6
# export QT_ENABLE_HIGHDPI_SCALING=0
export QT_FONT_DPI=132
#for GDK3
export GDK_SCALE=1
export GDK_DPI_SCALE=1
EOF
}

home_dpi() {
    cat >"$dpi_env" <<EOF
#DPI setting for home
export MONITOR_ENV=home
#for QT5
export QT_AUTO_SCREEN_SCALE_FACTOR=1
# export QT_SCALE_FACTOR=2
#for QT6
# export QT_ENABLE_HIGHDPI_SCALING=0
export QT_FONT_DPI=144
#for GDK3
export GDK_SCALE=1
export GDK_DPI_SCALE=1
EOF
}

note_dpi() {
    cat >"$dpi_env" <<EOF
#DPI setting for notebook
export MONITOR_ENV=note
#for QT5
export QT_AUTO_SCREEN_SCALE_FACTOR=1
#for QT6
# export QT_ENABLE_HIGHDPI_SCALING=1
export QT_FONT_DPI=96
EOF
}

monitor_name=$(xplugd -p | grep -w 'Model\s*:' | cut -d ':' -f 2 | head -n -1)

case $monitor_name in
    *EV2795*)
        # 显卡设置(xrandr setting later: to ensure position and DPI is correct)
        xrandr \
            --dpi 108 \
            --fb 4000x2560 \
            --output HDMI-0 \
            --pos 2560x0 \
            --rotate left \
            --output DP-0 --primary \
            --mode 2560x1440 \
            --pos 0x540 \
            --rotate normal \
            --panning 1440x2560+2560+0 \
            --output DP1 --off \
            --output eDP1 --off
        # dpi_env
        lab_dpi
        # 显卡设置(nvidia setting first: to enable forcecomposition)
        nvidia-settings --assign "CurrentMetaMode=DPY-1: nvidia-auto-select @2560x1440 +0+540 {ViewPortIn=2560x1440, ViewPortOut=2560x1440+0+0, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}, DPY-0: nvidia-auto-select @1440x2560 +2560+0 {ViewPortIn=1440x2560, ViewPortOut=2560x1440+0+0, Rotation=90, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}"
        xrdb -merge "${XDG_CONFIG_HOME:-$HOME/.config}"/displayset/labxresources
        # rofi setting
        ln -sf $HOME/.config/rofi/display.rasi $HOME/.config/rofi/config.rasi
        ;;
    *328P6VU* | *T278Q*)
        # 显卡设置(nvidia setting first: to enable forcecomposition)
        nvidia-settings --assign "CurrentMetaMode=DPY-1: nvidia-auto-select @3840x2160 +0+340 {ViewPortIn=3840x2160, ViewPortOut=3840x2160+0+0, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}, DPY-0: nvidia-auto-select @2160x3840 +3840+0 {AllowGSYNCCompatible=On, ViewPortIn=2160x3840, ViewPortOut=2560x1440+0+0, Rotation=270, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}"
        # dpi_env
        home_dpi
        # 显卡设置(xrandr setting later: to ensure position and DPI is correct)
        xrandr --dpi 138 \
            --fb 6000x3840 \
            --output HDMI-0 \
            --mode 2560x1440 \
						--rate 60 \
            --scale 1.5x1.5 \
            --pos 3840x0 \
            --rotate right \
            --output DP-0 --primary \
            --mode 3840x2160 \
						--rate 60 \
						--scale 1x1 \
            --pos 0x340 \
            --rotate normal \
            --output DP-1 --off \
            --output eDP1 --off \
            --output DP1 --off \
            --output HDMI1 --off \
            --output VIRTUAL1 --off
        xrdb -merge "${XDG_CONFIG_HOME:-$HOME/.config}"/displayset/homexresources
        # ICC setting
        dispwin -d1 -I /usr/share/color/icc/colord/PHL328P.icc &
        dispwin -d2 -I /usr/share/color/icc/colord/T278Q.icc &
        # rofi setting
        ln -sf $HOME/.config/rofi/display.rasi $HOME/.config/rofi/config.rasi
        ;;
    *)
        xrandr \
            --dpi 96 \
            --fb 1920x1080 \
            --output eDP1 --primary \
            --mode 1920x1080
        sudo brillo -s intel_backlight -S 50
        # dpi_env
        note_dpi
        xrdb -merge "${XDG_CONFIG_HOME:-$HOME/.config}"/displayset/xresources
        # rofi setting
        ln -sf $HOME/.config/rofi/notebook.rasi $HOME/.config/rofi/config.rasi
        ;;
esac
