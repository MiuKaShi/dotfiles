#!/bin/bash

COVER="/tmp/cover.png"
MUSIC_DIR="$HOME/Music"
BACKUP_COVER="$HOME/.config/ncmpcpp/cover.png"

get_cover() {
    ffmpeg -nostats -loglevel 0 -i "${MUSIC_DIR}"/"$(mpc current -f %file%)" "${COVER}" -y
    STATUS=$?

    # Check if the file has a embbeded album art
    if [ "$STATUS" -eq 0 ]; then
        echo "$COVER"
    else
        echo "$BACKUP_COVER"
    fi
}

send_notify() {
    status="$(mpc status)"
    if [[ ${status} == *"[playing]"* ]]; then
        dunstify -a Music --replace=27072 -t 3000 -i "$(get_cover)" "$(mpc --format '%title%-%artist%' current)"
    fi
}

while :; do
    mpc current --wait >/dev/null && send_notify || break
done
