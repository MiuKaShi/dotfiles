#!/bin/sh

# change /usr/bin/tlp /usr/bin/tlp-stat to run with NOPASSWD

LIST_STAT=('Enabled' 'Disabled')
cstat=${LIST_STAT[$(cat /sys/devices/system/cpu/intel_pstate/no_turbo)]}
min=$(lscpu | grep "MHz" | grep min | awk '{ print $4 }' | tr -d '.')
max=$(lscpu | grep "MHz" | grep max | awk '{ print $4 }' | tr -d '.')

power=$(tlp-stat -s | grep -oP 'Mode           = \K.*')
if [ "$power" = "battery" ]; then
    CPU_MIN=CPU_SCALING_MIN_FREQ_ON_BAT
    CPU_MAX=CPU_SCALING_MAX_FREQ_ON_BAT
else
    CPU_MIN=CPU_SCALING_MIN_FREQ_ON_AC
    CPU_MAX=CPU_SCALING_MAX_FREQ_ON_AC
fi

boost_notify(){
speed="$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq)"
speed="$(echo "${speed}" | awk '{ OFMT="%.2fGhz"; print $1 / 1000000 }')"
TITLE="Turbo Boost ${stat}"
MSG="Current max frequency: ${speed}"
notify-send -i device_cpu -t 5000 \
        "${TITLE}" \
        "${MSG}"
}

mode=$(printf "ðŸ’» Disabled\nðŸš€ Enabled" | dmenu -i -p "Boost toggle:")
if [ "$mode" = "ðŸ’» Disabled" ]; then
    stat="Disabled"
    if [ "$cstat" != "$stat" ]; then
        sudo -n tlp start -- CPU_BOOST_ON_BAT=0 CPU_BOOST_ON_AC=0
        boost_notify
    fi
elif [ "$mode" = "ðŸš€ Enabled" ]; then
    stat="Enabled"
    if [ "$cstat" != "$stat" ]; then
        sudo -n tlp start -- CPU_BOOST_ON_BAT=1 CPU_BOOST_ON_AC=1 "$CPU_MIN"="$min" "$CPU_MAX"="$max"
        boost_notify
    fi
else
    exit 0
fi

