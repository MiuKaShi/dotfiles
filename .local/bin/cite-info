#!/bin/sh

#Need to set environment variable $BIB first !

file=$(readlink -f "$1")
base="${file%.*}"

filebib=$base.bib
[ ! -f "$filebib" ] && notify-send -t 3000 "BIB" "Create bib file first!" && exit 1

citelist=$(grep '@' "$filebib" | grep -oP '(?<={).*' | tr -d ',' | grep -n '^' | dmenu -i -p "View Caitaion:")
[ -z "$citelist" ] && exit 1
citekey=$(echo "$citelist" | grep -oP '(?<=:).*')

pdfpath=$(bibtool -r biblatex -X "$citekey$" "$BIB" | awk '/\.pdf/ {print $3}' | tr -d '{}')

bibinfo=$(bibtool -r biblatex -X "$citekey$" "$filebib" | xargs | tr -d '{}' | tr , '\n')
doi=$(echo "$bibinfo" | grep DOI | grep -oP '(?<==[[:space:]]).*')
title=$(echo "$bibinfo" | grep Title | grep -oP '(?<==[[:space:]]).*')

if [ -n "$pdfpath" ]; then
    setsid -f xdg-open "$pdfpath" >/dev/null 2>&1
elif [ -n "$doi" ]; then
    setsid -f xdg-open http://dx.doi.org/"$doi" >/dev/null 2>&1 && xsel -b <<< "$doi"
else
    setsid -f xdg-open https://www.google.com/search?q="$title" >/dev/null 2>&1 && xsel -b <<< "$title"
fi
