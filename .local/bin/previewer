#!/bin/sh

file=$(readlink -f "$1")
dir=${file%/*}
name=$(basename "$file")
fname="${name%.*}"
base="/tmp/$fname"
ext="${file##*.}"

cd "$dir" || exit 1

textype() { \
	command="pdflatex"
	( head -n5 "$file" | grep -qi 'xelatex' ) && command="xelatex"
	$command --output-directory="$dir" "$base" &&
	grep -qi addbibresource "$file" &&
	biber --input-directory "$dir" "$base" &&
	$command --output-directory="$dir" "$base" &&
	$command --output-directory="$dir" "$base"
}

case "$ext" in
	norg) lowdown --parse-no-intraemph "$file" -Tms | groff -mpdfmark -ms -kept -T pdf > "$base".pdf ;;
	md) mdpdf -O "$file" ;;
	mom) preconv "$file" | refer -PS -e | groff -mom -kept -T pdf > "$base".pdf ;;
	ms) preconv "$file" | refer -PS -e | groff -me -ms -kept -T pdf > "$base".pdf ;;
	org) emacs "$file" --batch -u "$USER" -f org-latex-export-to-pdf ;;
	tex) textype "$file" ;;
esac

open(){ \
    case "$ext" in
	    tex|m[dse]|[rR]md|mom|norg|[0-9]) setsid -f xdg-open "$base".pdf >/dev/null 2>&1 ;;
	    html) setsid -f "$BROWSER" "$base".html >/dev/null 2>&1 ;;
    esac

}

#check if file is opening

if lsof -t "$base".pdf >/dev/null 2>&1; then
    notify-send -t 1000 "Update Preview"
else
    open "$base" && notify-send -t 1000 "Open Preview"
fi



