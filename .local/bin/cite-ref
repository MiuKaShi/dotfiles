#!/bin/sh

# Define variables with more meaningful names
FILE=$(readlink -f "$1")
NAME=$(basename "$FILE")
FILENAME="${NAME%.*}"
DIRECTORY=${FILE%/*}
FORMATER=/home/miuka/.config/script/upcitekey.py

# Change directory and exit if it fails
cd "$DIRECTORY" || exit 1

# Use consistent indentation and add spaces around operators
get_bib() {
    curl -v -H "Accept: application/x-bibtex" --form input=@"$FILE" --form consolidateCitations=1 https://kermitt2-grobid.hf.space/api/processReferences >"$FILENAME.bib"
    bibtex-tidy --quiet --modify --omit=date,day,number --curly --numeric --align=13 "$FILENAME.bib"
    notify-send -t 3000 "Bibtex" "Bibtex file created"
}

# Call get_bib function if the bib file does not exist
if [ ! -f "$FILENAME.bib" ]; then
    get_bib
fi

# Format the bib file using the upcitekey.py script and bibtex-tidy
python "$FORMATER" -k "$FILENAME.bib"
bibtex-tidy --quiet --modify --omit=date,day,number --curly --numeric --align=13 "$FILENAME.bib"

# Open the bib file in nvim
nvim "$FILENAME.bib"
