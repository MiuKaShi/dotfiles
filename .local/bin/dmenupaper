#!/bin/sh

# Open PDF based on citekey

# Get citekey from user input or command line argument
get_citekey() {
    if [ -z "$1" ]; then
        citekey=$(grep '@' <"$BIB" | grep -oP '(?<={).*' | tr -d ',' | dmenu -i -p "Open papers with citekey:")
    else
        citekey="$1"
    fi
}

get_pdf_title() {
    awk -v RS='@' -v key="$1" '$0 ~ key {print}' $BIB | grep -i title | awk -F" = " '{print $2}' | sed 's/[{},]//g'
}

# Get list of PDF paths associated with the given citekey
get_pdf_path() {
    bibtool -r biblatex -X "$1" "$BIB" | awk '/\.pdf/ {print $3}' | tr -d '{}' | sed 's/;/\n/g'
}

# Select a PDF from a list of paths
select_pdf() {
    if [ "$(echo "$1" | wc -l)" -ge 2 ]; then
        pdf_selected=$(echo "$1" | dmenu -i -p "Select items:")
    else
        pdf_selected="$1"
    fi
}

# Open the selected PDF in the default viewer
open_pdf() {
    xdg-open "$1" &
}

# Main function to open a PDF based on a citekey
main() {
    get_citekey "$1"
    pdf_path=$(get_pdf_path "$citekey")
    if [[ -z "$pdf_path" ]]; then
        pdf_title=$(get_pdf_title "$citekey")
        query=$(echo "$pdf_title" | tr ' ' '+') # replace spaces with '+' for the URL
        $BROWSER "https://www.google.com/search?q=$query" &
    else
        select_pdf "$pdf_path"
        open_pdf "$pdf_selected"
    fi
}

main "$@"
