#!/bin/sh

file=$(readlink -f "$1")
base="${file%.*}"

filebib=$base.bib
[[ ! -f $filebib ]] && notify-send -t 3000 "BIB" "Create bib file first!" && exit

citelist=$(cat $filebib | grep '@' | grep -oP '(?<={).*' | tr -d ',' | grep -n '^' | dmenu -i -p "View Caitaion:")
[[ ! $citelist ]] && exit
citekey=$(echo $citelist | grep -oP '(?<=:).*')

pdfpath=$(bibtool -r biblatex -X "$citekey$" "$BIB" | awk '/File/ {print $3}' | tr -d '{}')

bibinfo=$(bibtool -r biblatex -X "$citekey$" "$filebib" | xargs | tr -d '{}')
doi=$(echo $bibinfo | tr , '\n' | grep DOI | grep -oP '(?<==[[:space:]]).*')
title=$(echo $bibinfo | tr , '\n' | grep Title | grep -oP '(?<==[[:space:]]).*')

if [[ $pdfpath ]]; then
    xdg-open "$pdfpath" &
elif [[ $doi ]]; then
    handlr open http://dx.doi.org/"$doi"
else
    handlr open https://www.google.com/search?q="$title"
fi


