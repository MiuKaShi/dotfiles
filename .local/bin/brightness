#!/usr/bin/env bash

# This script allows control monitor brightness

# Get monitor info
monitor_info=$(sudo ddcutil detect)

# Check if DDC is supported
echo "$monitor_info" | awk '/Display 1/,0' | grep -q "DDC communication failed" && dunstify "DDC Not Support" && exit 1

# Extract model info
model_info=$(echo "$monitor_info" | grep "I2C bus\|Model" | sed '/^$/d;s/[[:blank:]]//g')
id=$(echo "$model_info" | grep -oP '(?<=i2c-)\w+')

# Set initial brightness value
if [ ! -f ~/.cache/brightness ]; then
    current_brightness=$(sudo ddcutil --noverify getvcp 10 | grep "current value" | awk '{print $9}' | sed 's/,*$//g')
    echo "$current_brightness" >~/.cache/brightness
fi
brightness=$(cat ~/.cache/brightness)

# Send notification to user
send_notification() {
    dunstify -a "changebrightness" -u low -r 9991 -h int:value:"$number_brightness" -i "number_brightness-$1" "Brightness: $number_brightness%" -t 2000
}

# Modify this function as needed to handle setting your monitor brightness
set_brightness() {
    while read -r line; do
        sudo ddcutil --noverify --bus "$line" --sleep-multiplier 0.1 setvcp 10 "$number_brightness" >/dev/null 2>&1
    done <<<"$id"
}

# Modify this function as needed to handle setting your monitor temperature
set_temperature() {
    while read -r line; do
        sudo ddcutil --noverify --bus "$line" --sleep-multiplier 0.1 setvcp 14 "$number_temperature" >/dev/null 2>&1
    done <<<"$id"
}

# Handle command line arguments
case "$1" in
    up)
        number_brightness=$(expr "$brightness" + 10)
        if [ "$number_brightness" -gt 100 ]; then
            number_brightness=100
        fi
        echo $number_brightness >~/.cache/brightness
        send_notification "$number_brightness"
        set_brightness "$number_brightness"
        ;;
    down)
        number_brightness=$(expr "$brightness" - 10)
        if [ "$number_brightness" -lt 0 ]; then
            number_brightness=0
        fi
        echo $number_brightness >~/.cache/brightness
        send_notification "$number_brightness"
        set_brightness "$number_brightness"
        ;;
    dark)
        number_brightness=0
        number_temperature=0x04
        set_brightness "$number_brightness"
        set_temperature "$number_temperature"
        ;;
    light)
        number_brightness=100
        number_temperature=0x06
        set_brightness "$number_brightness"
        set_temperature "$number_temperature"
        ;;
    day)
        number_brightness=30
        number_temperature=0x05
        set_brightness "$number_brightness"
        set_temperature "$number_temperature"
        ;;
esac

