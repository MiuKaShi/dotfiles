#! /bin/sh

dpi_env="$HOME/.config/shell/hidpi"

print_monitors() {
    while read -r output conn hex; do
        echo "$output	$conn	$(xxd -r -p <<<"${hex:-2d}")"
    done < <(LC_ALL=C xrandr --prop | tr -d '\r' | awk '
	h && /[^ \ta-f0-9]/ {
		n = split(hex, names, "000000fc00")
		hex = ""
		for (i = 2; i <= n; i++) {
			name = substr(names[i], 0, 26) "0a"
			sub(/0a.*/, "", name)
			if (name) {
				if (hex) name = "20" (name "")
				hex = hex (name "")
			}
		}
		h = 0
	}
	!/^[ \t]/ {
		if (ok) print output, conn, hex
		output = $1
		conn = output; sub(/-.*$/, "", conn)
		ok = (output && (substr($2, 0, 1) == "c"))  # Connected output
		hex = ""
		h = 0
	}
	h {sub(/[ \t]+/, ""); hex = hex ($0 "")}
	/EDID.*:/ {h=1; ok=(output && 1)}
	/ConnectorType:/ {conn = $2}
	END {if (ok) print output, conn, hex}
	' | sort)
}

lab_dpi() {
    cat >"$dpi_env" <<EOF
#DPI setting for lab
export MONITOR_ENV=lab
#for QT5
export QT_AUTO_SCREEN_SCALE_FACTOR=1
# export QT_SCALE_FACTOR=2
#for QT6
export QT_ENABLE_HIGHDPI_SCALING=0
export QT_FONT_DPI=132
#for GDK3
export GDK_SCALE=1
export GDK_DPI_SCALE=1
EOF
}

home_dpi() {
    cat >"$dpi_env" <<EOF
#DPI setting for home
export MONITOR_ENV=home
#for QT5
export QT_AUTO_SCREEN_SCALE_FACTOR=1
# export QT_SCALE_FACTOR=2
#for QT6
export QT_ENABLE_HIGHDPI_SCALING=0
export QT_FONT_DPI=144
#for GDK3
export GDK_SCALE=1
export GDK_DPI_SCALE=1
EOF
}

note_dpi() {
    cat >"$dpi_env" <<EOF
#DPI setting for notebook
export MONITOR_ENV=note
#for QT5
export QT_AUTO_SCREEN_SCALE_FACTOR=1
#for QT6
export QT_ENABLE_HIGHDPI_SCALING=1
export QT_FONT_DPI=96
EOF
}

monitor_name=$(print_monitors | awk '{print $3}')

case $monitor_name in
    *"EV2795"*)
        # 显卡设置(xrandr setting later: to ensure position and DPI is correct)
        xrandr \
            --dpi 108 \
            --fb 4000x2560 \
            --output HDMI-0 \
            --pos 2560x0 \
            --rotate left \
            --output DP-0 --primary \
            --mode 2560x1440 \
            --pos 0x540 \
            --rotate normal \
            --panning 1440x2560+2560+0 \
            --output DP1 --off \
            --output eDP1 --off
        # dpi_env
				lab_dpi
        # 显卡设置(nvidia setting first: to enable forcecomposition)
        nvidia-settings --assign "CurrentMetaMode=DPY-1: nvidia-auto-select @2560x1440 +0+540 {ViewPortIn=2560x1440, ViewPortOut=2560x1440+0+0, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}, DPY-0: nvidia-auto-select @1440x2560 +2560+0 {ViewPortIn=1440x2560, ViewPortOut=2560x1440+0+0, Rotation=90, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}"
        xrdb "${XDG_CONFIG_HOME:-$HOME/.config}"/displayset/labxresources &
        xrdbpid=$!
        ;;
    *"PHL"* | *"T278Q"*)
        # 显卡设置(nvidia setting first: to enable forcecomposition)
				nvidia-settings --assign "CurrentMetaMode=DPY-1: nvidia-auto-select @3840x2160 +0+340 {ViewPortIn=3840x2160, ViewPortOut=3840x2160+0+0, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}, DPY-0: nvidia-auto-select @2160x3840 +3840+0 {AllowGSYNCCompatible=On, ViewPortIn=2160x3840, ViewPortOut=2560x1440+0+0, Rotation=270, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}"
        # nvidia-settings --assign "CurrentMetaMode=DPY-1: {AllowGSYNCCompatible=On,  ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}, DPY-0: nvidia-auto-select @2160x3840 +3840+0 {ViewPortIn=2160x3840, ViewPortOut=2560x1440+0+0, Rotation=270, ForceCompositionPipeline=On, ForceFullCompositionPipeline=On}"
        # dpi_env
				home_dpi
        # 显卡设置(xrandr setting later: to ensure position and DPI is correct)
        xrandr --dpi 138 \
            --fb 6000x3840 \
            --output HDMI-0 \
            --scale 1.5x1.5 \
            --mode 2560x1440 \
            --pos 3840x0 \
            --rotate right \
            --output DP-0 --primary \
            --mode 3840x2160 \
            --pos 0x340 \
            --rotate normal \
            --output DP-1 --off \
            --output eDP1 --off \
            --output DP1 --off \
            --output HDMI1 --off \
            --output VIRTUAL1 --off
        xrdb "${XDG_CONFIG_HOME:-$HOME/.config}"/displayset/homexresources &
        xrdbpid=$!
        # ICC setting
				dispwin -d1 -I /usr/share/color/icc/colord/PHL328P.icc &
				dispwin -d2 -I /usr/share/color/icc/colord/T278Q.icc &
        ;;
    *)
        xrandr \
          --dpi 96 \
          --output eDP1 \
          --mode 1920x1080 
				sudo brillo -s intel_backlight -S 50
        # dpi_env
				note_dpi
        xrdb "${XDG_CONFIG_HOME:-$HOME/.config}"/displayset/xresources &
        xrdbpid=$!
        ;;
esac

# disable dispaly DPMS 
sleep 1; xset dpms 0 0 0
