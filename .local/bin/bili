#!/bin/bash

RESOLUTION='2000x900' #弹幕大小
URL="$(echo "$1" | awk -F'?' '{print $1}')"
BVID="$(echo "$URL" | awk -F'/video/' '{print $2}' | awk -F'/' '{print $1}')"
mkdir -p "/tmp/$BVID"

#视频CID
CID="$(curl -s "https://api.bilibili.com/x/player/pagelist?bvid=${BVID}&jsonp=jsonp" | jq '.data[0].cid')"
#视频弹幕
DANMAKU_POOL="https://api.bilibili.com/x/v2/dm/web/seg.so?type=1&oid=${CID}&segment_index=1"
curl -s "$DANMAKU_POOL" -o "/tmp/${BVID}/seg.so" && biliass "/tmp/${BVID}/seg.so" -f protobuf -s "$RESOLUTION" -o "/tmp/${BVID}/danmaku.ass"

setsid -f mpv -quiet "$URL" --referrer=https://www.bilibili.com --sub-file=/tmp/"$BVID"/danmaku.ass  >/dev/null 2>&1
